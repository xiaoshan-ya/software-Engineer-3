ISSUE_INFO
superset
v1.3
15480
michael-s-molina
2021-06-30T17:10:21Z
2021-07-20T16:29:43Z
pull_request
size/XL,Turing,v1.3,
BEGIN_ISSUE
### SUMMARY
Improves the Select component UI/UX - iteration 4.
- Migrates the native filters Select components to the new Select
- Fixes some bugs of the Select component related to searching and selection
- Simplifies the Select API for the async non-paginated version

Touched components:
```
src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigForm/ColumnSelect.tsx
src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigForm/FiltersConfigForm.tsx
src/filters/components/common.ts
src/filters/components/GroupBy/GroupByFilterPlugin.tsx
src/filters/components/Select/SelectFilterPlugin.tsx
src/filters/components/TimeColumn/TimeColumnFilterPlugin.tsx
src/filters/components/TimeGrain/TimeGrainFilterPlugin.tsx
```
@rusackas @villebro 

### BEFORE/AFTER SCREENSHOTS OR ANIMATED GIF
https://user-images.githubusercontent.com/70410625/124596960-40682000-de39-11eb-8ca5-0cb26af8080b.mp4

### TESTING INSTRUCTIONS
- Enter in a dashboard
- Open the filter bar
- Open the native filter modal
- Check the selects of the native filter modal
- After adding some filters check the selects in the filter bar

### ADDITIONAL INFORMATION
- [ ] Has associated issue:
- [x] Changes UI
- [ ] Includes DB Migration (follow approval process in [SIP-59](https://github.com/apache/superset/issues/13351))
  - [ ] Migration is atomic, supports rollback & is backwards-compatible
  - [ ] Confirm DB migration upgrade and downgrade tested
  - [ ] Runtime estimates and downtime expectations provided
- [ ] Introduces new feature or API
- [ ] Removes existing feature or API

COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
@jinghua-qa @junlincc @rosemarie-chiu @rusackas Can you help me test the native filters with the new select?
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
/testenv up
COMMENT_INFO
github-actions[bot]
2021-06-30T17:10:21Z
BEGIN_COMMENT
@michael-s-molina Ephemeral environment spinning up at http://54.186.197.32:8080. Credentials are `admin`/`admin`. Please allow several minutes for bootstrapping and startup.
COMMENT_INFO
github-actions[bot]
2021-06-30T17:10:21Z
BEGIN_COMMENT
@geido Ephemeral environment spinning up at http://54.191.248.224:8080. Credentials are `admin`/`admin`. Please allow several minutes for bootstrapping and startup.
COMMENT_INFO
codecov[bot]
2021-06-30T17:10:21Z
BEGIN_COMMENT
# [Codecov](https://codecov.io/gh/apache/superset/pull/15480?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) Report
> Merging [#15480](https://codecov.io/gh/apache/superset/pull/15480?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) (1b8cc4d) into [master](https://codecov.io/gh/apache/superset/commit/9a14aed152e103f9e719cb3c2cb37104cea76ecd?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) (9a14aed) will **increase** coverage by `0.05%`.
> The diff coverage is `69.29%`.

[![Impacted file tree graph](https://codecov.io/gh/apache/superset/pull/15480/graphs/tree.svg?width=650&height=150&src=pr&token=KsB0fHcx6l&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)](https://codecov.io/gh/apache/superset/pull/15480?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)

```diff
@@            Coverage Diff             @@
##           master   #15480      +/-   ##
==========================================
+ Coverage   77.06%   77.12%   +0.05%     
==========================================
  Files         983      983              
  Lines       51620    51645      +25     
  Branches     6992     6991       -1     
==========================================
+ Hits        39783    39833      +50     
+ Misses      11612    11588      -24     
+ Partials      225      224       -1     
```

| Flag | Coverage Î” | |
|---|---|---|
| javascript | `71.81% <69.29%> (+0.12%)` | :arrow_up: |

Flags with carried forward coverage won't be shown. [Click here](https://docs.codecov.io/docs/carryforward-flags?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#carryforward-flags-in-the-pull-request-comment) to find out more.

| [Impacted Files](https://codecov.io/gh/apache/superset/pull/15480?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) | Coverage Î” | |
|---|---|---|
| [...nfigModal/FiltersConfigForm/getControlItemsMap.tsx](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2Rhc2hib2FyZC9jb21wb25lbnRzL25hdGl2ZUZpbHRlcnMvRmlsdGVyc0NvbmZpZ01vZGFsL0ZpbHRlcnNDb25maWdGb3JtL2dldENvbnRyb2xJdGVtc01hcC50c3g=) | `85.96% <Ã¸> (Ã¸)` | |
| [...filters/components/GroupBy/GroupByFilterPlugin.tsx](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2ZpbHRlcnMvY29tcG9uZW50cy9Hcm91cEJ5L0dyb3VwQnlGaWx0ZXJQbHVnaW4udHN4) | `0.00% <0.00%> (Ã¸)` | |
| [...s/components/TimeColumn/TimeColumnFilterPlugin.tsx](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2ZpbHRlcnMvY29tcG9uZW50cy9UaW1lQ29sdW1uL1RpbWVDb2x1bW5GaWx0ZXJQbHVnaW4udHN4) | `0.00% <0.00%> (Ã¸)` | |
| [...ers/components/TimeGrain/TimeGrainFilterPlugin.tsx](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2ZpbHRlcnMvY29tcG9uZW50cy9UaW1lR3JhaW4vVGltZUdyYWluRmlsdGVyUGx1Z2luLnRzeA==) | `0.00% <0.00%> (Ã¸)` | |
| [...onfigModal/FiltersConfigForm/FiltersConfigForm.tsx](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2Rhc2hib2FyZC9jb21wb25lbnRzL25hdGl2ZUZpbHRlcnMvRmlsdGVyc0NvbmZpZ01vZGFsL0ZpbHRlcnNDb25maWdGb3JtL0ZpbHRlcnNDb25maWdGb3JtLnRzeA==) | `73.76% <66.66%> (+0.17%)` | :arrow_up: |
| [...ersConfigModal/FiltersConfigForm/DatasetSelect.tsx](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2Rhc2hib2FyZC9jb21wb25lbnRzL25hdGl2ZUZpbHRlcnMvRmlsdGVyc0NvbmZpZ01vZGFsL0ZpbHRlcnNDb25maWdGb3JtL0RhdGFzZXRTZWxlY3QudHN4) | `77.50% <77.50%> (Ã¸)` | |
| [superset-frontend/src/components/Select/utils.ts](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2NvbXBvbmVudHMvU2VsZWN0L3V0aWxzLnRz) | `92.30% <85.71%> (+4.80%)` | :arrow_up: |
| [...tersConfigModal/FiltersConfigForm/ColumnSelect.tsx](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2Rhc2hib2FyZC9jb21wb25lbnRzL25hdGl2ZUZpbHRlcnMvRmlsdGVyc0NvbmZpZ01vZGFsL0ZpbHRlcnNDb25maWdGb3JtL0NvbHVtblNlbGVjdC50c3g=) | `96.15% <100.00%> (Ã¸)` | |
| [...ters/FiltersConfigModal/FiltersConfigForm/utils.ts](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2Rhc2hib2FyZC9jb21wb25lbnRzL25hdGl2ZUZpbHRlcnMvRmlsdGVyc0NvbmZpZ01vZGFsL0ZpbHRlcnNDb25maWdGb3JtL3V0aWxzLnRz) | `90.47% <100.00%> (+1.58%)` | :arrow_up: |
| [...src/filters/components/Range/RangeFilterPlugin.tsx](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2ZpbHRlcnMvY29tcG9uZW50cy9SYW5nZS9SYW5nZUZpbHRlclBsdWdpbi50c3g=) | `88.23% <100.00%> (Ã¸)` | |
| ... and [13 more](https://codecov.io/gh/apache/superset/pull/15480/diff?src=pr&el=tree-more&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) | |

------

[Continue to review full report at Codecov](https://codecov.io/gh/apache/superset/pull/15480?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation).
> **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)
> `Î” = absolute <relative> (impact)`, `Ã¸ = not affected`, `? = missing data`
> Powered by [Codecov](https://codecov.io/gh/apache/superset/pull/15480?src=pr&el=footer&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). Last update [9a14aed...1b8cc4d](https://codecov.io/gh/apache/superset/pull/15480?src=pr&el=lastupdated&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation).

COMMENT_INFO
rusackas
2021-06-30T17:10:21Z
BEGIN_COMMENT
Hmmm... something seems amiss, if I'm not mistaken. If I go to the Sales Dashboard, and create a new filter, the default dataset should be "cleaned_sales_data" but the Select now shows "27"
![image](https://user-images.githubusercontent.com/812905/125025036-29931a80-e03f-11eb-9f1f-7c2f5f88baa8.png)

"cleaned_sales_data" doesn't show up in the options list, but I _can_ search for it. When I select it, and create a filter, like so...
![image](https://user-images.githubusercontent.com/812905/125025125-5ba47c80-e03f-11eb-8d57-0850e9d17ef3.png)

I get this error in the filter bar:
![image](https://user-images.githubusercontent.com/812905/125025158-6828d500-e03f-11eb-8fdc-66f19589e476.png)

However, the value filter DOES seem to work fine in other dashboards... which is confusing. The above issue is happening on the ephemeral env. I'll try it on a local build and see if I get the same results...
COMMENT_INFO
rusackas
2021-06-30T17:10:21Z
BEGIN_COMMENT
Well hmm... on my local build, with the Sales Dashboard, I see the correct data source in the Select. However, I can't create functional native filters (attempted value and numeric range) on that dashboard. I get that "Cannot load filter" error. On other dashboards, things are working seemingly fine. Something is amiss, but I'm not yet sure if it's the data source, the dashboard, or the feature(s).
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
@rusackas Thanks for testing this. I'll investigate the problem with the Sales Dashboard.
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
@rusackas 

> Hmmm... something seems amiss, if I'm not mistaken. If I go to the Sales Dashboard, and create a new filter, the default dataset should be "cleaned_sales_data" but the Select now shows "27"

Fixed

> I get this error in the filter bar:
> ![image](https://user-images.githubusercontent.com/812905/125025158-6828d500-e03f-11eb-8fdc-66f19589e476.png)

When I try to add a default value I get "Error: Time column "OrderDate" does not exist in dataset". So probably this dataset is corrupted and you can ignore this error.
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
/testenv up FEATURE_DASHBOARD_NATIVE_FILTERS=true
COMMENT_INFO
github-actions[bot]
2021-06-30T17:10:21Z
BEGIN_COMMENT
@michael-s-molina Ephemeral environment spinning up at http://34.221.21.236:8080. Credentials are `admin`/`admin`. Please allow several minutes for bootstrapping and startup.
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
@rusackas I want to do a small change before merging to deal with a scenario where we don't have any dashboards and add a filter. I'll request your review again when it's done.
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
@rusackas You can continue your review ðŸ˜‰ 
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
/testenv up FEATURE_DASHBOARD_NATIVE_FILTERS=true
COMMENT_INFO
github-actions[bot]
2021-06-30T17:10:21Z
BEGIN_COMMENT
@michael-s-molina Ephemeral environment spinning up at http://34.213.106.215:8080. Credentials are `admin`/`admin`. Please allow several minutes for bootstrapping and startup.
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
@rusackas I'll do the suggested changes in a follow-up PR. @geido Can we get your approval as well?
COMMENT_INFO
geido
2021-06-30T17:10:21Z
BEGIN_COMMENT
Sure @michael-s-molina . I'll do some manual testing as well today and come back to you.
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
@geido @rusackas @junlincc 

> I have noticed a problem with the creation of new options. It is now allowing for the creation of existing options, which would then make unselecting any of the duplicated options impossible. It gets stuck.
> 
> I don't see my newly created option "test" in the dropdown in multiple mode
> 
> I don't see my newly created option in the dropdown in single mode. I think this used to work consistently with the single mode ON and allowNewOptions OFF, where the selected option is highlighted at top of the options list
> 

After investigation, I discovered that these were not bugs in the new `Select` component but problems in the `SelectFilterPlugin` component.  `SelectFilterPlugin` contained duplicated logic already present in the `Select` component. I removed the duplicated logic.

> I am not sure if this is related to this PR but I am unable to create hierarchical filters. The child filter never appears anywhere. Only the parent is showing up. When I go back to editing, the hierarchical option is always unchecked as if it wasn't saved.
> 

This was in fact related to this PR. Fixed.

> After adding a new filter, the previously selected options of the existing filters are not selected anymore. This may be because I haven't clicked "Apply", however, as a user I would expect that my filters remain filled as I add or delete other filters, even before applying (I am fine if this needs to be discussed outside of the scope of this PR)
> 

This one is by design, until now we only keep the values if the user clicks on "Apply". We can change this behavior if the product team agrees but if that's the case we need to open another low priority issue.

@rusackas @geido I also applied all your suggestions.

@geido Thanks for testing the features. I updated the environment and requested your review again.
COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
/testenv up FEATURE_DASHBOARD_NATIVE_FILTERS=true
COMMENT_INFO
github-actions[bot]
2021-06-30T17:10:21Z
BEGIN_COMMENT
@michael-s-molina Ephemeral environment spinning up at http://52.36.69.174:8080. Credentials are `admin`/`admin`. Please allow several minutes for bootstrapping and startup.
COMMENT_INFO
geido
2021-06-30T17:10:21Z
BEGIN_COMMENT
Hey @michael-s-molina. Thanks for the fixes. There's only one problem that I could find. See below

When I choose _Time Grain_ and a default value, it won't allow me to select the option _Original value_. It fails to select it. This happens on both the modal and the left sidebar

<img width="1086" alt="Screen Shot 2021-07-20 at 17 12 03" src="https://user-images.githubusercontent.com/60598000/126349431-d693af54-2eb5-4884-829d-119b592a617c.png">

<img width="1102" alt="Screen Shot 2021-07-20 at 17 24 03" src="https://user-images.githubusercontent.com/60598000/126351138-580b12aa-45d0-4f3e-bc7e-bec89ae3d834.png">


COMMENT_INFO
michael-s-molina
2021-06-30T17:10:21Z
BEGIN_COMMENT
@geido This problem is already happening on master so I'll open another PR to fix it so we can merge this one.
COMMENT_INFO
github-actions[bot]
2021-06-30T17:10:21Z
BEGIN_COMMENT
Ephemeral environment shutdown and build artifacts deleted.
