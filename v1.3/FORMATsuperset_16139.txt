### SUMMARY Add support for time grain based native-filters and cross-filters. The frontend work is done in https://github.com/apache-superset/superset-ui/pull/1281 (this PR can be merged independently of that PR, as it only adds backend support for the feature). Other changes:  - Add new `TypedDict`s for `AdhocFilterClause` and `QueryObjectFilterClause` and implement necessary changes where we were previously assuming filters were `Dict[str, Any]`. - Break up `to_adhoc` function into `simple_filter_to_adhoc` and `form_data_to_adhoc`, as the previous implementation was mixing filter objects with form data. Also fix affected tests + remove a mock that is deemed unnecessary.  ### ADDITIONAL INFORMATION <!--- Check any relevant boxes with "x" --> <!--- HINT: Include "Fixes #nnn" if you are fixing an existing issue --> - [ ] Has associated issue: - [ ] Changes UI - [ ] Includes DB Migration (follow approval process in [SIP-59](https://github.com/apache/superset/issues/13351))   - [ ] Migration is atomic, supports rollback & is backwards-compatible   - [ ] Confirm DB migration upgrade and downgrade tested   - [ ] Runtime estimates and downtime expectations provided - [ ] Introduces new feature or API - [ ] Removes existing feature or API  
# [Codecov](https://codecov.io/gh/apache/superset/pull/16139?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) Report > Merging [#16139](https://codecov.io/gh/apache/superset/pull/16139?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) (ba0121b) into [master](https://codecov.io/gh/apache/superset/commit/ddb500590072ede3349a2a85a5d28a7953e21e32?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) (ddb5005) will **decrease** coverage by `0.12%`. > The diff coverage is `86.06%`.  > :exclamation: Current head ba0121b differs from pull request most recent head 2ff35a8. Consider uploading reports for the commit 2ff35a8 to get more accurate results [![Impacted file tree graph](https://codecov.io/gh/apache/superset/pull/16139/graphs/tree.svg?width=650&height=150&src=pr&token=KsB0fHcx6l&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)](https://codecov.io/gh/apache/superset/pull/16139?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)  ```diff @@            Coverage Diff             @@ ##           master   #16139      +/-   ## ========================================== - Coverage   76.83%   76.71%   -0.13%      ==========================================   Files         995      996       +1        Lines       52884    52954      +70        Branches     6721     6725       +4      ========================================== - Hits        40636    40626      -10      - Misses      12023    12103      +80        Partials      225      225               ```  | Flag | Coverage Œî | | |---|---|---| | hive | `?` | | | mysql | `81.58% <87.50%> (+0.04%)` | :arrow_up: | | postgres | `81.61% <87.50%> (+<0.01%)` | :arrow_up: | | presto | `81.44% <87.50%> (+0.05%)` | :arrow_up: | | python | `81.87% <87.50%> (-0.25%)` | :arrow_down: | | sqlite | `81.21% <87.50%> (+<0.01%)` | :arrow_up: |  Flags with carried forward coverage won't be shown. [Click here](https://docs.codecov.io/docs/carryforward-flags?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#carryforward-flags-in-the-pull-request-comment) to find out more.  | [Impacted Files](https://codecov.io/gh/apache/superset/pull/16139?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) | Coverage Œî | | |---|---|---| | [.../src/components/dataViewCommon/TableCollection.tsx](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2NvbXBvbmVudHMvZGF0YVZpZXdDb21tb24vVGFibGVDb2xsZWN0aW9uLnRzeA==) | `100.00% <√∏> (√∏)` | | | [...ontrols/DndColumnSelectControl/DndFilterSelect.tsx](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2V4cGxvcmUvY29tcG9uZW50cy9jb250cm9scy9EbmRDb2x1bW5TZWxlY3RDb250cm9sL0RuZEZpbHRlclNlbGVjdC50c3g=) | `45.07% <√∏> (√∏)` | | | [...nents/controls/MetricControl/AdhocMetricOption.jsx](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2V4cGxvcmUvY29tcG9uZW50cy9jb250cm9scy9NZXRyaWNDb250cm9sL0FkaG9jTWV0cmljT3B0aW9uLmpzeA==) | `75.00% <√∏> (√∏)` | | | [...s/controls/MetricControl/MetricDefinitionValue.jsx](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2V4cGxvcmUvY29tcG9uZW50cy9jb250cm9scy9NZXRyaWNDb250cm9sL01ldHJpY0RlZmluaXRpb25WYWx1ZS5qc3g=) | `80.00% <√∏> (√∏)` | | | [...mponents/controls/MetricControl/MetricsControl.jsx](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2V4cGxvcmUvY29tcG9uZW50cy9jb250cm9scy9NZXRyaWNDb250cm9sL01ldHJpY3NDb250cm9sLmpzeA==) | `82.94% <√∏> (√∏)` | | | [superset/utils/profiler.py](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvdXRpbHMvcHJvZmlsZXIucHk=) | `47.05% <47.05%> (√∏)` | | | [...ontrols/DndColumnSelectControl/DndMetricSelect.tsx](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2V4cGxvcmUvY29tcG9uZW50cy9jb250cm9scy9EbmRDb2x1bW5TZWxlY3RDb250cm9sL0RuZE1ldHJpY1NlbGVjdC50c3g=) | `41.78% <50.00%> (-0.29%)` | :arrow_down: | | [...plore/components/controls/OptionControls/index.tsx](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2V4cGxvcmUvY29tcG9uZW50cy9jb250cm9scy9PcHRpb25Db250cm9scy9pbmRleC50c3g=) | `88.88% <60.00%> (-1.54%)` | :arrow_down: | | [superset/initialization/\_\_init\_\_.py](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvaW5pdGlhbGl6YXRpb24vX19pbml0X18ucHk=) | `87.72% <75.00%> (-0.19%)` | :arrow_down: | | [superset/extensions.py](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvZXh0ZW5zaW9ucy5weQ==) | `92.68% <85.71%> (-0.66%)` | :arrow_down: | | ... and [18 more](https://codecov.io/gh/apache/superset/pull/16139/diff?src=pr&el=tree-more&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) | |  ------  [Continue to review full report at Codecov](https://codecov.io/gh/apache/superset/pull/16139?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). > **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) > `Œî = absolute <relative> (impact)`, `√∏ = not affected`, `? = missing data` > Powered by [Codecov](https://codecov.io/gh/apache/superset/pull/16139?src=pr&el=footer&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). Last update [ddb5005...2ff35a8](https://codecov.io/gh/apache/superset/pull/16139?src=pr&el=lastupdated&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation).  
/testenv up FEATURE_DASHBOARD_NATIVE_FILTERS=true FEATURE_DASHBOARD_CROSS_FILTERS=true 
@villebro Ephemeral environment spinning up at http://34.212.190.175:8080. Credentials are `admin`/`admin`. Please allow several minutes for bootstrapping and startup. 
FYI this doesn't work properly with SQLite yet due to the dates being strings. If it's important to add support for SQLite I can add that - otherwise I propose leaving it to a follow-up PR for a rainy day. 
Ephemeral environment shutdown and build artifacts deleted. 
üè∑ 2021.31 
