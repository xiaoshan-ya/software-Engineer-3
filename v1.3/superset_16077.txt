ISSUE_INFO
superset
v1.3
16077
pkdotson
2021-08-04T23:26:49Z
2021-08-10T16:29:50Z
pull_request
risk:db-migration,size/L,rush!,#bug:blocking!,preset-io,v1.3,preset:2021.31,
BEGIN_ISSUE
### SUMMARY
This pr fixes an issue where user would view charts and run queries without saving but the api would return that user had modified the chart. This was caused because of a change in the api using query_context where accessing the slice table would do an automatic saved changed_on_delta_humanize. This pr add two new cols to the Slice table so that the user only see's actually modified charts.

### BEFORE/AFTER SCREENSHOTS OR ANIMATED GIF
before:

https://user-images.githubusercontent.com/17326228/128384423-36b496e7-cd96-4b39-b4da-775ecb814fef.mov

after


https://user-images.githubusercontent.com/17326228/128393886-6ce5f8d3-4975-4fe1-bfd4-03a69d6df276.mov





### TESTING INSTRUCTIONS
<!--- Required! What steps can be taken to manually verify the changes? -->

### ADDITIONAL INFORMATION
<!--- Check any relevant boxes with "x" -->
<!--- HINT: Include "Fixes #nnn" if you are fixing an existing issue -->
- [x ] Has associated issue: fixes https://github.com/apache/superset/issues/15990
- [ ] Changes UI
- [ x] Includes DB Migration (follow approval process in [SIP-59](https://github.com/apache/superset/issues/13351))
  - [x ] Migration is atomic, supports rollback & is backwards-compatible
  - [x ] Confirm DB migration upgrade and downgrade tested
  - [ ] Runtime estimates and downtime expectations provided
- [ ] Introduces new feature or API
- [ ] Removes existing feature or API

COMMENT_INFO
github-actions[bot]
2021-08-04T23:26:49Z
BEGIN_COMMENT
âš ï¸ @pkdotson Your base branch `master` has just also updated `superset/migrations`.

â— **Please consider rebasing your branch to avoid db migration conflicts.**
COMMENT_INFO
codecov[bot]
2021-08-04T23:26:49Z
BEGIN_COMMENT
# [Codecov](https://codecov.io/gh/apache/superset/pull/16077?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) Report
> Merging [#16077](https://codecov.io/gh/apache/superset/pull/16077?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) (80f4abe) into [master](https://codecov.io/gh/apache/superset/commit/2bfc1c29c571a482bb38e359f5f3b5d19ba03939?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) (2bfc1c2) will **decrease** coverage by `0.16%`.
> The diff coverage is `95.65%`.

[![Impacted file tree graph](https://codecov.io/gh/apache/superset/pull/16077/graphs/tree.svg?width=650&height=150&src=pr&token=KsB0fHcx6l&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)](https://codecov.io/gh/apache/superset/pull/16077?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)

```diff
@@            Coverage Diff             @@
##           master   #16077      +/-   ##
==========================================
- Coverage   76.76%   76.60%   -0.17%     
==========================================
  Files         995      996       +1     
  Lines       52881    52960      +79     
  Branches     6721     6736      +15     
==========================================
- Hits        40596    40571      -25     
- Misses      12059    12163     +104     
  Partials      226      226              
```

| Flag | Coverage Î” | |
|---|---|---|
| hive | `?` | |
| javascript | `71.20% <85.71%> (-0.02%)` | :arrow_down: |
| mysql | `81.53% <100.00%> (-0.06%)` | :arrow_down: |
| postgres | `81.59% <100.00%> (-0.02%)` | :arrow_down: |
| python | `81.68% <100.00%> (-0.31%)` | :arrow_down: |
| sqlite | `81.20% <100.00%> (-0.02%)` | :arrow_down: |

Flags with carried forward coverage won't be shown. [Click here](https://docs.codecov.io/docs/carryforward-flags?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#carryforward-flags-in-the-pull-request-comment) to find out more.

| [Impacted Files](https://codecov.io/gh/apache/superset/pull/16077?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) | Coverage Î” | |
|---|---|---|
| [...ntend/src/explore/components/ExploreChartPanel.jsx](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2V4cGxvcmUvY29tcG9uZW50cy9FeHBsb3JlQ2hhcnRQYW5lbC5qc3g=) | `15.00% <Ã¸> (Ã¸)` | |
| [superset/charts/api.py](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvY2hhcnRzL2FwaS5weQ==) | `85.82% <Ã¸> (+0.11%)` | :arrow_up: |
| [...perset-frontend/src/views/CRUD/chart/ChartList.tsx](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL3ZpZXdzL0NSVUQvY2hhcnQvQ2hhcnRMaXN0LnRzeA==) | `72.90% <85.71%> (+0.23%)` | :arrow_up: |
| [superset/charts/commands/create.py](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvY2hhcnRzL2NvbW1hbmRzL2NyZWF0ZS5weQ==) | `92.15% <100.00%> (+0.49%)` | :arrow_up: |
| [superset/charts/commands/update.py](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvY2hhcnRzL2NvbW1hbmRzL3VwZGF0ZS5weQ==) | `88.40% <100.00%> (+0.71%)` | :arrow_up: |
| [superset/charts/schemas.py](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvY2hhcnRzL3NjaGVtYXMucHk=) | `100.00% <100.00%> (Ã¸)` | |
| [superset/models/slice.py](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvbW9kZWxzL3NsaWNlLnB5) | `86.41% <100.00%> (+0.22%)` | :arrow_up: |
| [superset/views/core.py](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvdmlld3MvY29yZS5weQ==) | `75.25% <100.00%> (+0.03%)` | :arrow_up: |
| [superset/db\_engines/hive.py](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvZGJfZW5naW5lcy9oaXZlLnB5) | `0.00% <0.00%> (-82.15%)` | :arrow_down: |
| [superset/db\_engine\_specs/hive.py](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQvZGJfZW5naW5lX3NwZWNzL2hpdmUucHk=) | `69.80% <0.00%> (-16.87%)` | :arrow_down: |
| ... and [32 more](https://codecov.io/gh/apache/superset/pull/16077/diff?src=pr&el=tree-more&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) | |

------

[Continue to review full report at Codecov](https://codecov.io/gh/apache/superset/pull/16077?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation).
> **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)
> `Î” = absolute <relative> (impact)`, `Ã¸ = not affected`, `? = missing data`
> Powered by [Codecov](https://codecov.io/gh/apache/superset/pull/16077?src=pr&el=footer&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). Last update [2bfc1c2...80f4abe](https://codecov.io/gh/apache/superset/pull/16077?src=pr&el=lastupdated&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation).

COMMENT_INFO
zhaoyongjie
2021-08-04T23:26:49Z
BEGIN_COMMENT
@pkdotson Maybe I missed some details. I'm curious as to why a get method would modify the metadata? Should we avoid this operation? I searched all of the codebases seems that only [save_or_overwrite_slice](https://github.com/apache/superset/blob/423ff50768cd1d70fc63a29ac3312916d4aaf65e/superset/views/core.py#L919) can change slice object.

COMMENT_INFO
github-actions[bot]
2021-08-04T23:26:49Z
BEGIN_COMMENT
âš ï¸ @pkdotson Your base branch `master` has just also updated `superset/migrations`.

â— **Please consider rebasing your branch to avoid db migration conflicts.**
COMMENT_INFO
suddjian
2021-08-04T23:26:49Z
BEGIN_COMMENT
@zhaoyongjie I'm not sure exactly where it happens either, but one of @betodealmeida's changes started saving `query_context`. It's not unheard of for `GET` requests to involve db writes, when the server wants to save some aspect of a request or lazily calculate and then save a value, so I think it's okay.

The main thing here is that the value being used for "last modified" in the UI should not be something that auto-updates when a database row is written. This PR makes it more explicit.
COMMENT_INFO
pkdotson
2021-08-04T23:26:49Z
BEGIN_COMMENT
/testenv up
COMMENT_INFO
github-actions[bot]
2021-08-04T23:26:49Z
BEGIN_COMMENT
@pkdotson Ephemeral environment spinning up at http://35.164.126.87:8080. Credentials are `admin`/`admin`. Please allow several minutes for bootstrapping and startup.
COMMENT_INFO
pkdotson
2021-08-04T23:26:49Z
BEGIN_COMMENT
/testenv up
COMMENT_INFO
github-actions[bot]
2021-08-04T23:26:49Z
BEGIN_COMMENT
@pkdotson Ephemeral environment spinning up at http://52.38.130.113:8080. Credentials are `admin`/`admin`. Please allow several minutes for bootstrapping and startup.
COMMENT_INFO
github-actions[bot]
2021-08-04T23:26:49Z
BEGIN_COMMENT
Ephemeral environment shutdown and build artifacts deleted.
COMMENT_INFO
rosemarie-chiu
2021-08-04T23:26:49Z
BEGIN_COMMENT
ðŸ· 2021.31
COMMENT_INFO
john-bodley
2021-08-04T23:26:49Z
BEGIN_COMMENT
I'm a little perplexed by this PR,

> This pr fixes an issue where user would view charts and run queries without saving but the api would return that user had modified the chart.

Shouldn't we remedy the root cause, i.e., prevent viewing of a slice from augmenting the database record, rather than adding additional columns to the table schema? This feels somewhat akin to the [There Was an Old Lady Who Swallowed a Fly
](https://en.wikipedia.org/wiki/There_Was_an_Old_Lady_Who_Swallowed_a_Fly) rhyme.
COMMENT_INFO
betodealmeida
2021-08-04T23:26:49Z
BEGIN_COMMENT
> I'm a little perplexed by this PR,
> 
> > This pr fixes an issue where user would view charts and run queries without saving but the api would return that user had modified the chart.
> 
> Shouldn't we remedy the root cause, i.e., prevent viewing of a slice from augmenting the database record, rather than adding additional columns to the table schema? This feels somewhat akin to the [There Was an Old Lady Who Swallowed a Fly ](https://en.wikipedia.org/wiki/There_Was_an_Old_Lady_Who_Swallowed_a_Fly) rhyme.

@john-bodley I added a change where the **first time** the user views a saved chart it does a `PUT` request storing the associated `query_context` in a new column (`slices.query_context`). This is needed because:

1. To get the data for a given chart, we need to `POST` the `query_context` to `/api/v1/chart/`.
2. To obtain `query_context` from `form_data` we need to run Javascript code unique to each visualization.

This means that, programmatically, **it was impossible to get the data for a given saved chart**, something we needed for reports.

We can't populate the new column `slices.query_context` with the migration script that added, since it requires Javascript code, so the charts now check to see if the column is null, and if so, they will do the `PUT` request to populate the column.

The side-effect of this is that charts are being shown as modified, even if they're not. The problem here is that the `changed_on` column is auto-populated by FAB every time the model changes, and we can't control that from Superset (please correct me if I'm wrong). Which is why @pkdotson added a custom column to track actual modifications by the user, and not by background processes.

Personally I don't see this as an anti-pattern. FAB offers a column `changed_on` for convenience, and if we need finer control I think it's ok to add a new column and track the updates ourselves. This has the potential to be useful for other use cases in the future, like migrations that modify the chart data.

I hope this clarifies things, and makes the solution more acceptable.
COMMENT_INFO
john-bodley
2021-08-04T23:26:49Z
BEGIN_COMMENT
@betodealmeida I don't have much context on the query context change, but when I read, the following,

> To get the data for a given chart, we need to POST the query_context to /api/v1/chart/

i.e., a `GET` request first requires a `POST` (to I gather the same table) I just wanted to check that we're confident in the pattern that's being used. Per _this_ PR it feels like _that_ change is snowballing and resulted in unforeseen behavior and thus thought there was merit in confirming that collectively the community was onboard with this approach.
