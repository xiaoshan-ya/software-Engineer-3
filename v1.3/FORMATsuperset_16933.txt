### SUMMARY When a component is dropped directly under a tab in the dashboard editor and the cross filter feature flag is enabled, the following error sometimes appears: ![image](https://user-images.githubusercontent.com/33317356/135617512-b7a2de56-8a50-469d-a9c0-39e2093d3fcf.png)  This is caused by the dashboard creating a wrapper component that marks itself as its parent, causing an infinite loop when traversing all children in the cross filter indicator. The reason for this was a logical error in the code, where the wrapper id was supposed to be added to the wrapped component, but ended up being added to the wrapper itself. Tests are added to check for this going forward.  ### DETAILS  When dropping a a component on the dashboard that requires wrapping (in this case dropping a markdown component directly on a tab, but could also be a chart, or column object: https://github.com/apache/superset/blob/87baac7650bdb6a8f8f82cf4992567a2c5c73cba/superset-frontend/src/dashboard/util/shouldWrapChildInRow.js#L27-L39), the component is wrapped in a wrapper component (in this case a ROW component). However, the wrapper adds itself as it's own parent, while it should add itself to the wrapped component: ![image](https://user-images.githubusercontent.com/33317356/135616201-42a7bb12-087b-4043-9e83-782e8ae7bf60.png)  Interestingly enough, after saving the dashboard, the layout metadata is fixed: - the wrapped component correctly references the wrapper as its closest parent - the wrapper no longer references itself  See the screenshot below for the post-save state: ![image](https://user-images.githubusercontent.com/33317356/135616416-0b099491-14d1-4e33-8fa7-1efd2249b441.png)  With the changes in this PR, the parents are correct after creation, i.e. won't change after saving.  This bug exposed several problems in the associated code, causing unnecessary performance problems. However, these should be fixed in follow-up PRs.  ### TESTING INSTRUCTIONS Local testing  ### ADDITIONAL INFORMATION <!--- Check any relevant boxes with "x" --> <!--- HINT: Include "Fixes #nnn" if you are fixing an existing issue --> - [x] Has associated issue: closes #16436 - [ ] Required feature flags: - [ ] Changes UI - [ ] Includes DB Migration (follow approval process in [SIP-59](https://github.com/apache/superset/issues/13351))   - [ ] Migration is atomic, supports rollback & is backwards-compatible   - [ ] Confirm DB migration upgrade and downgrade tested   - [ ] Runtime estimates and downtime expectations provided - [ ] Introduces new feature or API - [ ] Removes existing feature or API  
# [Codecov](https://codecov.io/gh/apache/superset/pull/16933?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) Report > Merging [#16933](https://codecov.io/gh/apache/superset/pull/16933?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) (8fe7d81) into [master](https://codecov.io/gh/apache/superset/commit/87baac7650bdb6a8f8f82cf4992567a2c5c73cba?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) (87baac7) will **not change** coverage. > The diff coverage is `100.00%`.  [![Impacted file tree graph](https://codecov.io/gh/apache/superset/pull/16933/graphs/tree.svg?width=650&height=150&src=pr&token=KsB0fHcx6l&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)](https://codecov.io/gh/apache/superset/pull/16933?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation)  ```diff @@           Coverage Diff           @@ ##           master   #16933   +/-   ## =======================================   Coverage   76.97%   76.97%            =======================================   Files        1022     1022              Lines       54903    54903              Branches     7485     7485            =======================================   Hits        42262    42262              Misses      12393    12393              Partials      248      248            ```  | Flag | Coverage Δ | | |---|---|---| | javascript | `71.03% <100.00%> (ø)` | |  Flags with carried forward coverage won't be shown. [Click here](https://docs.codecov.io/docs/carryforward-flags?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#carryforward-flags-in-the-pull-request-comment) to find out more.  | [Impacted Files](https://codecov.io/gh/apache/superset/pull/16933?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) | Coverage Δ | | |---|---|---| | [...frontend/src/dashboard/util/newEntitiesFromDrop.js](https://codecov.io/gh/apache/superset/pull/16933/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation#diff-c3VwZXJzZXQtZnJvbnRlbmQvc3JjL2Rhc2hib2FyZC91dGlsL25ld0VudGl0aWVzRnJvbURyb3AuanM=) | `100.00% <100.00%> (ø)` | |  ------  [Continue to review full report at Codecov](https://codecov.io/gh/apache/superset/pull/16933?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). > **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation) > `Δ = absolute <relative> (impact)`, `ø = not affected`, `? = missing data` > Powered by [Codecov](https://codecov.io/gh/apache/superset/pull/16933?src=pr&el=footer&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). Last update [87baac7...8fe7d81](https://codecov.io/gh/apache/superset/pull/16933?src=pr&el=lastupdated&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=The+Apache+Software+Foundation).  
/testenv up FEATURE_DASHBOARD_NATIVE_FILTERS=true FEATURE_DASHBOARD_CROSS_FILTERS=true FEATURE_DASHBOARD_NATIVE_FILTERS_SET=true FEATURE_DASHBOARD_FILTERS_EXPERIMENTAL=true   
@geido Ephemeral environment spinning up at http://34.220.230.231:8080. Credentials are `admin`/`admin`. Please allow several minutes for bootstrapping and startup. 
Tested by adding charts to different level of tabs in the sales dashboard, with charts, components being added and removed a few times, not seeing errors. Thank you for the fix! @villebro  Curious to know why this issue is not reproducible consistently?  
Ephemeral environment shutdown and build artifacts deleted. 
Thanks for a very detailed description of the issue! 
